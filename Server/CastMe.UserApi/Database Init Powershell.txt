# 1. Start SQL Server container
docker-compose -f .\castme.userApi\docker-compose.yml up -d

# 2. Wait a bit for SQL Server to be ready
Write-Host "⏳ Waiting for SQL Server to start..."
Start-Sleep -Seconds 15

# 3. Ensure a local tool manifest exists
if (-not (Test-Path ".config/dotnet-tools.json")) {
    Write-Host "🛠 Creating tool manifest and installing dotnet-ef locally..."
    dotnet new tool-manifest
    dotnet tool install dotnet-ef
} elseif (-not (dotnet tool list | Select-String "dotnet-ef")) {
    Write-Host "📦 Installing dotnet-ef locally..."
    dotnet tool install dotnet-ef
} else {
    Write-Host "✅ dotnet-ef already available as local tool"
}

# 4. Apply EF Core migrations (use local tool)
dotnet tool run dotnet-ef database update `
  --project .\CastMe.User.Storage `
  --startup-project .\castme.userApi
